ci.vertices=TRUE,ci.vertices.height=0.1)
# 绘图
forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
data <- read_xlsx('敏感性分析后森林图(16个).xlsx')
data$`P−value` <- as.numeric(data$`P−value`)
data$`P−value` <- sprintf('%.3f',data$`P−value`)
data[1,3] <- 'P-value'
# 把OR、CI三列改为数值格式
data$or <- as.numeric(data$or)
data$or_lci95 <- as.numeric(data$or_lci95)
data$or_uci95 <- as.numeric(data$or_uci95)
data$`OR (95% CI)` <- paste0(sprintf("%.3f", data$or),' (',sprintf("%.3f", data$or_lci95),'-',sprintf("%.3f", data$or_uci95),')')
data[1,9] <- 'OR (95% CI)'
data <- data %>%
mutate(across(everything(), ~ifelse(. == "NA (NA-NA)", NA, .))) %>%
mutate(across(everything(), ~ifelse(. == "NA", NA, .)))
pdf("my_forestplot.pdf", family = "Times",width = 15,height = 8)
# 绘图
forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
dev.off()
dev.off()
dev.off()
pdf("my_forestplot.pdf", family = "Times",width = 15,height = 8)
# 绘图
forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
dev.off()
dev.off()
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
pdf("敏感性后森林图(16个).pdf", family = "Times",width = 15,height = 8)
# 绘图
print(plot)
dev.off()
color_vector <- ifelse(data$or > 1, "red", "royalblue")
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
plot
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = color_vector,summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
plot
color_vector <- ifelse(data$or > 1, "red", "royalblue")
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = color_vector,summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
plot
color_vector <-
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = ifelse(data$or > 1, "red", "royalblue"),summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
plot
plot <- forestplot(labeltext=as.matrix(data[,c(1:3,9)]), # 取要的数据
mean=data$or,  # OR
lower=data$or_lci95, # CI
upper=data$or_uci95, # CI
is.summary=c(T,T,F,F,T,F,F,F,F,F,T,F,F,F,F,T,F,F,T,F,F,F,F,F,F,F), # 加粗的行数
# 图形位置
graph.pos=4,
# 标题
#title='Diabetic kidney disease',
# 字的大小
txt_gp=fpTxtGp(label = gpar(cex=0.8),
ticks = gpar(cex=0.8),
xlab = gpar(cex=0.8),
title = gpar(cex=1.2)),
# X轴刻度和坐标
xticks = c(0,0.5,1.0, 1.5,2.0,2.5,3),
xlab="OR (95% CI)",
zero=1,
# 分隔横线http://127.0.0.1:19473/graphics/plot_zoom_png?width=1739&height=917
#hrzl_lines = gpar(col = "#444444"),
hrzl_lines=list('2'=gpar(lwd=1,lineend='square',columns=c(1:5),col='black')),
#ci_column = 1,
# 零点竖线颜色
#col=fpColors(zero = "black"),
# 行宽
colgap=unit(7,'mm'),
# 森林图的宽度
graphwidth=unit(6, "cm"),
# 置信区间剪裁 超过的会标箭头
clip=c(0.6,1.3),
# 圆点置信区间
#fn.ci_norm = fpDrawCircleCI,
fn.ci_norm = fpDrawNormalCI,
col=fpColors(box = 'royalblue',summary = 'red',lines = '#1c61b6',zero='grey32'),
# 粗细、大小
lwd.ci=1,boxsize=0.2,
# 两端竖线
ci.vertices=TRUE,ci.vertices.height=0.1)
plot
library(TwoSampleMR)
library(ggplot2)
library(data.table)
library(dplyr)
setwd("C:/Users/Zz/Desktop/免疫细胞")
iddf=read.table("imc731id.txt",header = T,sep = "\t")
imc=as.vector(iddf$id)
imc=imc[401:600]
# result=data.frame()
final_path <- 'result3.csv'
out_dat <- fread('finngen_R9_L12_ATOPIC.gz')
out_dat$samplesize <- 350062
out_dat$phenotype <- 'Atopic dermatitis'
out_dat <- format_data(dat = out_dat,type = 'outcome',
snp_col = 'rsids',chr_col = '#chrom',pos_col = 'pos',
effect_allele_col = 'alt',other_allele_col = 'ref',
pval_col = 'pval',beta_col = 'beta',se_col = 'sebeta',
eaf_col = 'af_alt',samplesize_col = 'samplesize',phenotype_col = 'phenotype')
out_dat$samplesize <- 350062
out_dat$phenotype <- 'Atopic dermatitis'
out_dat <- format_data(dat = out_dat,type = 'outcome',
snp_col = 'rsids',chr_col = '#chrom',pos_col = 'pos',
effect_allele_col = 'alt',other_allele_col = 'ref',
pval_col = 'pval',beta_col = 'beta',se_col = 'sebeta',
eaf_col = 'af_alt',samplesize_col = 'samplesize',phenotype_col = 'phenotype')
z <<- 1
zz <<- length(imc)
for (i in imc ) {
# i <- imc[1]
cat('(',z,'/',zz,') ',i,' to Atopic dermatitis',sep = '')
if (file.exists(final_path)){
save_id <<- fread(final_path)[[1]]
}else{
save_id <<- NULL
}
if (i %in% save_id){
cat(' 已跳过\n')
z <<- z+1
next
}
while (TRUE) {
tryCatch({
expo_rt<<-extract_instruments(outcome=i,p1 = 1e-5,
clump = T,
p2 = 1e-5,
r2 = 0.1,
kb = 500)
break
},error=function(error){
cat(' 重试')
})
}
expo_rt <<- nnMR::filter_F(expo_rt)
outc_rt <<- subset(out_dat,SNP %in% expo_rt[['SNP']])
# 在线
# while (TRUE) {
#   tryCatch({
#     outc_rt <- extract_outcome_data(
#       snps = expo_rt$SNP,
#       outcomes = 'finn-b-L12_ATOPIC')
#     break
#   },error=function(error){
#     cat('重试')
#   })
#
# }
dat_harmonised <<- harmonise_data(
exposure_dat =  expo_rt,
outcome_dat = outc_rt,action=2)
if (nrow(dat_harmonised)<3){
cat('Harmonise数量不足，跳过\n')
z <<- z+1
next
}
res <<- mr(dat_harmonised,method_list = c('mr_egger_regression','mr_weighted_median','mr_ivw'))
reg <<- generate_odds_ratios(res)
z <<- z+1
if(reg$pval[3]<0.05){
write.csv(dat_harmonised,paste0('harmonise/',i,'_harmonised.csv'))
tryCatch({
presso <<- TwoSampleMR::run_mr_presso(dat_harmonised,NbDistribution = 5000)
outlier_corrected_p <<- presso[[1]]$`Main MR results`$`P-value`[2]
global_p <<- presso[[1]]$`MR-PRESSO results`$`Global Test`$Pvalue
outliers <<- presso[[1]]$`MR-PRESSO results`$`Distortion Test`$`outliers Indices`
if (is.null(outliers)){
presso_dat <<- data.frame(list('exposure'=i,'PRESSO_outlier_corrected_p'=outlier_corrected_p,
'PRESSO_global_p'=global_p,'PRESSO_outliers'=NA))
}else{
presso_dat <<- data.frame(list('exposure'=i,'PRESSO_outlier_corrected_p'=outlier_corrected_p,
'PRESSO_global_p'=global_p,'PRESSO_outliers'=outliers))
}
},error=function(error){
presso_dat <<- data.frame(list('exposure'=i,'PRESSO_outlier_corrected_p'=NA,
'PRESSO_global_p'=NA,'PRESSO_outliers'=NA))
})
reg <<- reg[,-4]
colnames(reg)[1] <- 'exposure'
data <- merge(reg,presso_dat,by ='exposure')[c(1:3),]
# dat_harmonised <- data.table::fread('C:/Users/Zz/Desktop/gastroduodenal/remake/harmonise_file/M01110_harmonised.csv')
ple <- mr_pleiotropy_test(dat_harmonised)[,-c(1:3,6)]
ple$exposure <- i
colnames(ple)[3] <- 'plei_pval'
ht <- mr_heterogeneity(dat_harmonised)[2,-c(1:3,5)]
ht$i <- (ht$Q-ht$Q_df)/ht$Q
ht$exposure <- i
mgx <- merge(ple,ht,by='exposure')
new <- merge(data,mgx,by='exposure')
data <- new
if (!file.exists(final_path)){
data.table::fwrite(data,final_path)
}else{
existing_data <- data.table::fread(final_path)
new_data <- rbind(existing_data,data)
data.table::fwrite(new_data,final_path)
}
res_single <- TwoSampleMR::mr_singlesnp(dat_harmonised)
res_loo <- TwoSampleMR::mr_leaveoneout(dat_harmonised)
p1 <- TwoSampleMR::mr_scatter_plot(res, dat_harmonised)
ggplot2::ggsave(p1[[1]], file=paste0('./plot/',i,"_res.pdf"), width=7, height=7)
#森林图
p2 <- TwoSampleMR::mr_forest_plot(res_single)
##保存图片
ggplot2::ggsave(p2[[1]], file=paste0('./plot/',i,"_forest.pdf"), width=7, height=7)
##留一法图
p3 <- TwoSampleMR::mr_leaveoneout_plot(res_loo)
##保存图片
ggplot2::ggsave(p3[[1]], file=paste0('./plot/',i,"_loo.pdf"), width=7, height=7)
##漏斗图
res_single <- TwoSampleMR::mr_singlesnp(dat_harmonised)
p4 <- TwoSampleMR::mr_funnel_plot(res_single)
##保存图片
ggplot2::ggsave(p4[[1]], file=paste0('./plot/',i,"_single.pdf"), width=7, height=7)
}
}
